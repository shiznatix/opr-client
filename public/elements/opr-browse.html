<dom-module id="opr-browse">
	<template>
		<style include="opr-shared-styles">
			#browseContainer {
				height: 100%;
				@apply(--layout-vertical);
			}

			#browseBreadcrumbs {
				margin: 5px;
			}
			.breadcrumb {
				margin-right: 0;
				margin-left: 0;
				margin-bottom: 5px;
				min-width: 0;
				font-size: 3vw;
			}

			iron-list {
				@apply(--layout-flex);
			}
			paper-checkbox {
				width: 100%;
			}

			.entry {
				padding: 5px;
				font-size: 7vw;
				border-bottom: 1px solid var(--paper-blue-grey-900);
			}

			.unclickable {
				color: black;
			}

			#playEuqueueButtons {
				@apply(--layout-horizontal);
			}
			.playEuqueueButton {
				@apply(--layout-flex);
			}
		</style>

		<iron-location path="{{path}}"></iron-location>

		<iron-ajax
			id="browseAjax"
			url="/browse-server"
			handle-as="json"
			method="POST"
			content-type="application/json"
			on-response="handleResponse">
		</iron-ajax>
		<iron-ajax
			id="playEuqueueAjax"
			handle-as="json"
			method="POST"
			content-type="application/json"
			on-response="playEnqueueResponse">
		</iron-ajax>

		<div id="browseContainer">
			<div id="browseBreadcrumbs">
				<paper-button raised on-tap="onBreadcrumTapped" class="breadcrumb">/</paper-button>

				<template is="dom-repeat" items="[[breadcrumbs]]">
					<paper-button raised on-tap="onBreadcrumTapped" item="[[item]]" class="breadcrumb">[[item.dir]]</paper-button>
				</template>
			</div>

			<iron-list class="roundedContainer" items="[[folderContents]]">
				<template>
					<div class="entry" on-tap="onTap" file="[[item]]">
						<template is="dom-if" if="[[item.isPlayable]]">
							<paper-checkbox value="[[item.fullPath]]" on-change="checkboxChanged">
								<span class="text">[[item.name]]</span>
							</paper-checkbox>
						</template>
						<template is="dom-if" if="[[!item.isPlayable]]">
							<iron-icon icon="[[getIcon(item)]]"></iron-icon>
							<span class$="{{getUnplayableClasses(item)}}">[[item.name]]</span>
						</template>
					</div>
				</template>
			</iron-list>

			<div id="playEuqueueButtons" class="roundedContainer">
				<paper-button raised on-tap="enqueueSelected" class="playEuqueueButton" id="browseEnqueueButton" disabled>Enqueue</paper-button>
				<paper-button raised on-tap="insertAtSelected" class="playEuqueueButton" id="browseInsertAtButton" disabled>Insert at</paper-button>
				<paper-button raised on-tap="playSelected" class="playEuqueueButton" id="browsePlayButton" disabled>Play</paper-button>
			</div>
		</div>

		<opr-insert-at-dialog id="insertAtDialogElement"></opr-insert-at-dialog>

		<opr-toast id="browseToast"></opr-toast>
	</template>
	<script>
		Polymer({
			is: 'opr-browse',

			properties: {
				path: {
					type: String,
					observer: 'pathChanged',
				},
				breadcrumbs: {
					type: Array,
					value: [],
				},
				folderContents: {
					type: Array,
					value: [],
				}
			},

			attemptedFullPath: '/',
			currentFullPath: '/',
			selectedFiles: [],

			sendRequest: function(dir) {
				this.attemptedFullPath = dir;
				this.$.browseAjax.body = JSON.stringify({
					dir: dir,
				});
				this.$.browseAjax.generateRequest();
			},

			pathChanged: function() {
				if ('/browse' === this.path) {
					const latestBrowseFullPath = localStorage.getItem('latestBrowseFullPath');

					this.sendRequest((latestBrowseFullPath ? latestBrowseFullPath : '/'));
				}
			},

			getIcon: function(item) {
				if (item.isBack) {
					return 'icons:reply';
				}
				if (item.isDir) {
					return 'icons:folder';
				}

				return 'icons:clear';
			},

			getUnplayableClasses: function(item) {
				let classes = [
					'text',
				];

				if (!item.isBack && !item.isDir) {
					classes.push('unclickable');
				}

				return classes.join(' ');
			},

			onTap: function(event) {
				const file = event.currentTarget.file;

				if (file.isBack) {
					this.onBackTap();
				} else if (file.isDir) {
					this.sendRequest(file.fullPath);
				}
			},

			onBackTap: function() {
				this.breadcrumbs.pop();

				let dir;

				if (0 === this.breadcrumbs.length) {
					dir = '/';
				} else {
					dir = this.breadcrumbs[this.breadcrumbs.length - 1].fullPath;
				}

				this.sendRequest(dir);
			},

			onBreadcrumTapped: function(event) {
				const item = event.target.item,
					fullPath = (item ? item.fullPath : '/');

				// even if its the same as the current full path, do it.
				// its a good way to be able to refresh via button
				this.sendRequest(fullPath);
			},

			setBreadcrumbs: function(fullPath) {
				const parts = fullPath.split('/');
				let breadcrumbs = [],
					currentFullPath = '/';

				for (let i = 0; i < parts.length; i++) {
					const part = parts[i];

					if ('' === part) {
						continue;
					}

					currentFullPath = ('/' === currentFullPath ? `/${part}` : `${currentFullPath}/${part}`),

					breadcrumbs.push({
						dir: part,
						fullPath: currentFullPath,
					});
				}

				this.breadcrumbs = breadcrumbs;
			},

			handleResponse: function(event) {
				let response = event.detail.response.data,
					folderContents = [];

				for (let i = 0; i < response.length; i++) {
					response[i].isBack = false;
				}

				this.currentFullPath = this.attemptedFullPath;
				this.selectedFiles = [];
				this.setBrowseButtonsDisabled(true);
				localStorage.setItem('latestBrowseFullPath', this.currentFullPath);
				this.setBreadcrumbs(this.currentFullPath);

				if (this.breadcrumbs.length > 0) {
					folderContents.push({
						isBack: true,
						isDir: false,
						isPlayable: false,
						name: 'Back',
					});
				}

				this.folderContents = folderContents.concat(response);
			},

			checkboxChanged: function(event) {
				const target = event.target,
					index = this.selectedFiles.indexOf(target.value);

				if (target.checked) {
					this.selectedFiles.push(target.value);
				} else if (index > -1) {
					this.selectedFiles.splice(index, 1);
				}

				this.setBrowseButtonsDisabled((0 === this.selectedFiles.length));
			},

			setBrowseButtonsDisabled: function(disabled) {
				this.$.browseEnqueueButton.disabled = disabled;
				this.$.browseInsertAtButton.disabled = disabled;
				this.$.browsePlayButton.disabled = disabled;
			},

			enqueueSelected: function() {
				this.$.playEuqueueAjax.url = '/enqueue-playlist';
				this.$.playEuqueueAjax.body = JSON.stringify({
					filePaths: this.selectedFiles,
				});
				this.$.playEuqueueAjax.generateRequest();
			},

			insertAtSelected: function() {
				this.$.insertAtDialogElement.open((atIndex) => {
					this.$.playEuqueueAjax.url = '/set-at-playlist';
					this.$.playEuqueueAjax.body = JSON.stringify({
						atIndex: atIndex,
						filePaths: this.selectedFiles,
					});
					this.$.playEuqueueAjax.generateRequest();
				});
			},

			playSelected: function() {
				this.$.playEuqueueAjax.url = '/set-playlist';
				this.$.playEuqueueAjax.body = JSON.stringify({
					filePaths: this.selectedFiles,
				});
				this.$.playEuqueueAjax.generateRequest();
			},

			playEnqueueResponse: function(e) {
				let paperCheckboxes = this.querySelectorAll('paper-checkbox');
				this.selectedFiles = [];

				for (let i = 0; i < paperCheckboxes.length; i++) {
					paperCheckboxes[i].checked = false;
				}
				this.$.browseToast.toastFromPlaylistEvent(e);
			},
		});
	</script>
</dom-module>
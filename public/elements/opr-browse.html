<dom-module id="opr-browse">
	<template>
		<style include="opr-shared-styles">
			#browseList {
				background-color: var(--paper-blue-grey-700);
				margin: 10px;
				border-radius: 10px;
				padding: 10px;
			}

			#browseBreadcrumbs {
				margin: 5px;
			}

			#backEntry {
				background-color: var(--paper-blue-grey-500);
				padding-top: 10px;
				padding-bottom: 10px;
				cursor: pointer;
			}

			#playEuqueueButtons {
				width: 100%;
				margin-top: 5px;
			}

			.playEuqueueButton {
				width: 33%;
				margin: 0;
			}
		</style>

		<iron-location path="{{path}}"></iron-location>

		<iron-ajax
			id="browseAjax"
			url="/browse-server"
			handle-as="json"
			method="POST"
			content-type="application/json"
			on-response="handleResponse"
			last-response="{{folderContents}}">
		</iron-ajax>
		<iron-ajax
			id="playEuqueueAjax"
			handle-as="json"
			method="POST"
			content-type="application/json"
			on-response="playEnqueueResponse">
		</iron-ajax>

		<iron-list>
			<div id="browseBreadcrumbs">
				<paper-button raised on-tap="onBreadcrumTapped">/</paper-button>

				<template is="dom-repeat" items="[[breadcrumbs]]">
					<paper-button raised on-tap="onBreadcrumTapped" item="[[item]]">[[item.dir]]</paper-button>
				</template>
			</div>

			<div id="browseList">
				<template is="dom-if" if="[[breadcrumbs.length]]">
					<div on-tap="onBackTap" id="backEntry">
						<iron-icon icon="icons:reply"></iron-icon>
						<span class="text">Back</span>
					</div>
				</template>

				<template is="dom-repeat" items="[[folderContents.data]]">
					<div on-tap="onTap" file="[[item]]">
						<template is="dom-if" if="[[item.isPlayable]]">
							<paper-checkbox value="[[item.fullPath]]" on-change="checkboxChanged">
								<span class="text">[[item.name]]</span>
							</paper-checkbox>
						</template>
						<template is="dom-if" if="[[!item.isPlayable]]">
							<iron-icon icon="[[getIcon(item)]]"></iron-icon>
							<span class="text">[[item.name]]</span>
						</template>
					</div>
				</template>

				<div id="playEuqueueButtons">
					<paper-button raised on-tap="enqueueSelected" class="playEuqueueButton" id="browseEnqueueButton" disabled>Enqueue</paper-button>
					<paper-button raised on-tap="insertAtSelected" class="playEuqueueButton" id="browseInsertAtButton" disabled>Insert at</paper-button>
					<paper-button raised on-tap="playSelected" class="playEuqueueButton" id="browsePlayButton" disabled>Play</paper-button>
				</div>
			</div>
		</iron-list>

		<opr-insert-at-dialog id="insertAtDialogElement"></opr-insert-at-dialog>

		<opr-toast id="browseToast"></opr-toast>
	</template>
	<script>
		Polymer({
			is: 'opr-browse',

			properties: {
				path: {
					type: String,
					observer: 'pathChanged',
				},
				breadcrumbs: {
					type: Array,
					value: [],
				},
			},

			attemptedFullPath: '/',
			currentFullPath: '/',
			selectedFiles: [],

			sendRequest: function(dir) {
				this.attemptedFullPath = dir;
				this.$.browseAjax.body = JSON.stringify({
					dir: dir,
				});
				this.$.browseAjax.generateRequest();
			},

			pathChanged: function() {
				if ('/browse' === this.path) {
					const latestBrowseFullPath = localStorage.getItem('latestBrowseFullPath');

					this.sendRequest((latestBrowseFullPath ? latestBrowseFullPath : '/'));
				}
			},

			getIcon: function(item) {
				if (item.isDir) {
					return 'icons:folder';
				}

				return 'icons:clear';
			},

			onTap: function(event) {
				const file = event.currentTarget.file;

				if (file.isDir) {
					this.sendRequest(file.fullPath);
				}
			},

			onBackTap: function() {
				this.breadcrumbs.pop();

				let dir;

				if (0 === this.breadcrumbs.length) {
					dir = '/';
				} else {
					dir = this.breadcrumbs[this.breadcrumbs.length - 1].fullPath;
				}

				this.sendRequest(dir);
			},

			onBreadcrumTapped: function(event) {
				const item = event.target.item,
					fullPath = (item ? item.fullPath : '/');

				// even if its the same as the current full path, do it.
				// its a good way to be able to refresh via button
				this.sendRequest(fullPath);
			},

			setBreadcrumbs: function(fullPath) {
				const parts = fullPath.split('/');
				let breadcrumbs = [],
					currentFullPath = '/';

				for (let i = 0; i < parts.length; i++) {
					const part = parts[i];

					if ('' === part) {
						continue;
					}

					currentFullPath = ('/' === currentFullPath ? `/${part}` : `${currentFullPath}/${part}`),

					breadcrumbs.push({
						dir: part,
						fullPath: currentFullPath,
					});
				}

				this.breadcrumbs = breadcrumbs;
			},

			handleResponse: function() {
				this.currentFullPath = this.attemptedFullPath;
				this.selectedFiles = [];
				this.setBrowseButtonsDisabled(true);
				localStorage.setItem('latestBrowseFullPath', this.currentFullPath);
				this.setBreadcrumbs(this.currentFullPath);
			},

			checkboxChanged: function(event) {
				const target = event.target,
					index = this.selectedFiles.indexOf(target.value);

				if (target.checked) {
					this.selectedFiles.push(target.value);
				} else if (index > -1) {
					this.selectedFiles.splice(index, 1);
				}

				this.setBrowseButtonsDisabled((0 === this.selectedFiles.length));
			},

			setBrowseButtonsDisabled: function(disabled) {
				this.$.browseEnqueueButton.disabled = disabled;
				this.$.browseInsertAtButton.disabled = disabled;
				this.$.browsePlayButton.disabled = disabled;
			},

			enqueueSelected: function() {
				this.$.playEuqueueAjax.url = '/enqueue-playlist';
				this.$.playEuqueueAjax.body = JSON.stringify({
					filePaths: this.selectedFiles,
				});
				this.$.playEuqueueAjax.generateRequest();
			},

			insertAtSelected: function() {
				this.$.insertAtDialogElement.open((atIndex) => {
					this.$.playEuqueueAjax.url = '/set-at-playlist';
					this.$.playEuqueueAjax.body = JSON.stringify({
						atIndex: atIndex,
						filePaths: this.selectedFiles,
					});
					this.$.playEuqueueAjax.generateRequest();
				});
			},

			playSelected: function() {
				this.$.playEuqueueAjax.url = '/set-playlist';
				this.$.playEuqueueAjax.body = JSON.stringify({
					filePaths: this.selectedFiles,
				});
				this.$.playEuqueueAjax.generateRequest();
			},

			playEnqueueResponse: function(e) {
				let paperCheckboxes = this.querySelectorAll('paper-checkbox');
				this.selectedFiles = [];

				for (let i = 0; i < paperCheckboxes.length; i++) {
					paperCheckboxes[i].checked = false;
				}
				this.$.browseToast.toastFromPlaylistEvent(e);
			},
		});
	</script>
</dom-module>